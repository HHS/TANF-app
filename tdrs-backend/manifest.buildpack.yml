version: 1
applications:
- name: tdp-backend
  memory: 2G
  instances: 1
  disk_quota: 2G
  env:
    REDIS_URI: redis://localhost:6379
  buildpacks:
  - https://github.com/cloudfoundry/apt-buildpack
  - https://github.com/cloudfoundry/python-buildpack.git#v1.8.3
  command: "./gunicorn_start.sh"
- name: tdp-kibana
  memory: 2G
  disk_quota: 2G
  instances: 1
  services:
      - es-sandbox
  docker:
    image: elastic/kibana:7.17.10
  command: |
    export ELASTICSEARCH_HOSTS=http://tdp-elastic-proxy.apps.internal &&
    /bin/tini -- /usr/local/bin/kibana-docker
- name: tdp-elastic-proxy
  memory: 256M
  disk_quota: 256M
  instances: 1
  services:
      - es-sandbox
  docker:
    image: elipe17/aws-es-proxy:latest
  command: |
    export ENDPOINT=$(echo $VCAP_SERVICES | grep -Eo 'host[^,]*' | grep -Eo '[^:]*$' | tr -d '"' | sed -e 's/^/https:\/\//') &&
    export AWS_ACCESS_KEY_ID=$(echo $VCAP_SERVICES | grep -Eo 'access_key[^,]*' | grep -Eo '[^:]*$') &&
    export AWS_SECRET_ACCESS_KEY=$(echo $VCAP_SERVICES | grep -Eo 'secret_key[^,]*' | grep -Eo '[^:]*$') &&
    /usr/local/bin/aws-es-proxy -endpoint $ENDPOINT -listen 0.0.0.0:8080 -verbose -debug
