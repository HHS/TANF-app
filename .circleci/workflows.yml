workflows:
  build-and-test:
    unless:
      or:
        - << pipeline.parameters.run_dev_deployment >>
        - << pipeline.parameters.run_owasp_scan >>
    jobs:
      - secrets-check
      - test-frontend:
          requires:
            - secrets-check
      - test-backend:
          requires:
            - secrets-check

  dev-deployment:
    when:
      << pipeline.parameters.run_dev_deployment >>
    jobs:
      - deploy-infrastructure-dev:
          target_env: << pipeline.parameters.target_env >>
      - deploy-dev:
          target_env: << pipeline.parameters.target_env >>
          requires:
            - deploy-infrastructure-dev

  nightly:
    jobs:
      - nightly-owasp-scan:
          target_env: develop
          filters:
            branches:
              only:
                - develop
      - nightly-owasp-scan:
          target_env: staging
          filters:
            branches:
              only:
                - main
      - nightly-owasp-scan:
          target_env: prod
          cf_password: CF_PASSWORD_PROD
          cf_username: CF_USERNAME_PROD
          cf_space: tanf-prod
          filters:
            branches:
              only:
                - master
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - develop
                - main
                - master

  erd:
    jobs:
      - make_erd:
          filters:
            branches:
              only:
                develop

  owasp-scan:
    when: << pipeline.parameters.run_owasp_scan >>
    jobs:
      - backend-owasp-scan
      - frontend-owasp-scan

  staging-deployment:
    unless: << pipeline.parameters.run_dev_deployment >>
    jobs:
      - deploy-project-updates-site:
          filters:
            branches:
              only:
                - develop
      - deploy-infrastructure-staging:
          filters:
            branches:
              only:
                - main
      - deploy-staging:
          requires:
            - deploy-infrastructure-staging
          filters:
            branches:
              only:
                - main
      - deploy-infrastructure-develop:
          filters:
            branches:
              only:
                - develop
      - deploy-develop:
          requires:
            - deploy-infrastructure-develop
          filters:
            branches:
              only:
                - develop

  production-deployment:
    unless: << pipeline.parameters.run_dev_deployment >>
    jobs:
      - deploy-infrastructure-production:
          filters:
            branches:
              only:
                - master
      - deploy-production:
          requires:
            - deploy-infrastructure-production
          filters:
            branches:
              only:
                - master
